\chapter{Обзор предметной области}
\label{chapter1}

\section{Darcs}

Darcs~--- распределённая система контроля версий, использующая внутри
себя специально разработанную \emph{теорию патчей}. В ней, в отличие
от большинства других распределённых систем контроля версий,
отсутствует понятие <<ветки>>: любое подмножество множетсва всех
имеющихся в данном репозитории патчей можно рассматривать как
\emph{рабочую копию}.

\subsection{Обзор}

В каждый момент времени времени сосуществуют следующие три
элемента: % TODO элемента? не самое удачное слово

\begin{itemize}
\item рабочая директория (Working directory),
\item чистое дерево (Pristine Tree),
\item множество патчей.
\end{itemize}

\begin{definition}[Рабочая директория]
  Единственный из этих трёх элементов, который (при нормальном
  использовании) меняет пользователь. Директория, в которой,
  непосредственно, находятся файлы, за которыми следит Darcs.

  Может содержать изменения, которые ещё не находятся под контролем.
\end{definition}

\begin{definition}[Множество патчей]
  Все патчи, с которыми когда-либо работали в рамках этого репозитория.
\end{definition}

\begin{definition}[Чистое дерево]
  Последнее \emph{записанное} состояние рабочей директории. При
  \emph{записи} рабочая директория будет сравниваться именно с ним.
  Представляет собой список патчей, которые надо применить к пустой
  директории, чтобы получить заданное дерево.
\end{definition}

Стандартный процесс работы с Darcs-репозиторием выглядит так. 

\begin{itemize}
\item Создание пустого репозитория (init);
\item Добавление файлов (add);
\item Запись изменённой рабочей директории (record);
\item Установка метки на текущее записанное состояние (tag);
\item Отправка своей рабочей копии на удалённый сервер (pull);
\end{itemize}

В этой работе не будет детально рассматриваться синтаксис работы с
каждой из них. Вместо этого будет более подробно рассмотрено
внутреннее строение системы.

\subsection{Виды патчей}

Каждый патч состоит из последовательности \emph{элементарных патчей}. 
В Darcs используются следующие виды элементарных патчей:

\begin{definition}[Элементарный патч]
\begin{itemize}
\item Создание пустой директории с именем $d$;
\item Удаление пустой директории с именем $d$;
\item Создание пустого файла с именем $f$;
\item Удаление пустого файла с именем $f$;
\item Добавление в файл $f$ после $n$-й строки строк $s_1, s_2, \ldots s_k$;
\item Удаление из файла $f$ после $n$-й строки строк $s_1, s_2, \ldots s_k$;
\item Замена во всём файле $f$ \emph{слова} $s$ на слово $t$, если
  слова $t$ до этого не встречалось.
\item 
\end{itemize}
\end{definition}

Очевидно, что применение даже элементарного патча возможно не всегда.
Например, нельзя создать файл, если файл с таким именем уже
существует. Или, нельзя удалить пятую строку <<Петя>>, если там
написано <<Вася>>.

\begin{definition}[Контекст]
  Множество всех рабочих директорий, к которым применим патч $p$,
  называется \emph{контекстом патча} $p$.
\end{definition}

\begin{notation}
  Будем обозначать как ${}^aA^b$ патч $A$, который после применения к
  контексту $a$ даёт контекст $b$. Последовательное применение сначала
  патча ${}^aA^b$, а затем, патча ${}^bB^c$ будем обозначать как
  ${}^aA^bB^c$ или, если это не вызывает никаких неоднозначностей,
  просто $AB$. 
\end{notation}

\subsection{Группа патчей}

При проектировании системы, элементарные патчи выбирались так, чтобы
для каждого элементарного патча ${}^aA^b$ существовал обратный
${}^b{A^{-1}}^a$ такой, что ${\cal E}({}^aA^b(A^{-1})^a) = {\cal
  E}({}^aI^a)$, где за ${\cal E}(A)$ обозначается \emph{эффект} от
патча $A$, а $I$~--- патч, который ничего не делает.

Подобно построению свободной группы, построим группу патчей над
элементарными патчами. Напомним, что патч~--- это последовательность
элементарных патчей. Будем считать, что никаких проблем во время
применения патчей в этой последовательности не возникает.

\begin{definition}[Группа патчей]
  В определении группы требуется существование следующего:

  \begin{itemize}
  \item Нулевой элемент~--- пустая последовательность;
  \item Обратный элемент
    $({}^{c_1}P_1^{c_2}P_2^{c_3}\ldots P_n^{c_{n+1}})^{-1} =
    {}^{c_{n+1}}P_n^{c_n}\ldots P_2^{c_2}P_1^{c_1}$;
  \item Групповая операция~--- последовательное применение сначала
    первого патча, а затем, второго.
  \end{itemize}
\end{definition}

\subsection{Коммутация патчей}

Коммутация патчей~--- один из важнейших механизмов в Darcs. С помощью
неё возможна реализация функциональности merge~--- объединения
результатов работы нескольких авторов.

\begin{definition}[Коммутация патчей]
  Патчи ${}^ap^b$ и ${}^bq^c$ \emph{коммутируют}, если существует
  такой контекст $d$ и такие патчи ${}^d{p'}^c$ и ${}^a{q'}^d$, что
  ${\cal E}(p) = {\cal E}(p')$ и ${\cal E}(q) = {\cal E}(q')$.

  Если такие $p'$ и $q'$ существуют, то пишут, что $p, q
  \longleftrightarrow q', p'$.
\end{definition}

Другими словами, патчи коммутируют, если их в последовательном
применении можно поменять местами без ущерба для результата.
Очевидно, что патчи коммутируют не всегда. Например, патчи <<создание
файла $f$>> и <<запись в первую строку файла $f$ строки $s$>> не
коммутируют~--- нельзя сначала записать что-то в файл, а потом его
создать. Патчи же $p = $ <<замена в файле $f$ слова $s$ на слово $t$>>
и $q = $ <<удаление пятой строки файла $f$>> коммутируют, при этом, $p
= p'$, а $q = q'$. 

Рассмотрим более подробно более сложный пример коммутации. 




\section{Выводы по главе \ref{chapter1}}
