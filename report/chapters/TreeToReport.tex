\section{Деревья}

\AgdaHide{
\begin{code}%
\>\AgdaKeyword{module} \AgdaModule{TreeToReport} \AgdaKeyword{where}\<%
\\
%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{OXIj.BrutalDepTypes}\<%
\\
%
\\
\>\AgdaKeyword{open} \AgdaModule{≡-Prop}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{A} \AgdaSymbol{:} \AgdaPrimitiveType{Set}\<%
\end{code}
}


В этой части будет рассмотрен второй вид ревизии~--- двоичные
деревья~(рисунок~\ref{fig:repotypes-tree}).

Дадим классическое определение двоичного дерева: дерево это либо лист,
который хранит какое-то значение, либо левое и правое поддеревья.

\begin{code}%
\>\AgdaKeyword{data} \AgdaDatatype{Tree} \AgdaSymbol{:} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Leaf} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{val} \AgdaSymbol{:} \AgdaPostulate{A}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Tree}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Branch} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{left} \AgdaBound{right} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Tree}\<%
\end{code}
  
\subsection{Форма}

Возьмём в качестве \emph{формы} патчей двоичное дерево, в листьях
которого стоит либо метка \AgdaInductiveConstructor{Take}, означающая,
что эта вершина вместе со всем её поддеревом будет заменена патчем,
либо метка \AgdaInductiveConstructor{Skip}, означающая, что патч будет
игнорировать эту вершину и никак на неё не повлияет.

\begin{code}%
\>\AgdaKeyword{data} \AgdaDatatype{Form} \AgdaSymbol{:} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Take} \AgdaSymbol{:} \AgdaDatatype{Form}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Skip} \AgdaSymbol{:} \AgdaDatatype{Form}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Branch} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{left} \AgdaBound{right} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Form}\<%
\end{code}

Естесственным образом вводится опеределение совместности таких форм.
Формы совместны, если:

\begin{code}%
\>\AgdaKeyword{data} \AgdaDatatype{\_∥\_} \AgdaSymbol{:} \AgdaDatatype{Form} \AgdaSymbol{→} \AgdaDatatype{Form} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\end{code}

В корне первой стоит метка \AgdaInductiveConstructor{Skip}

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{s} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{Skip} \AgdaDatatype{∥} \AgdaBound{s}\<%
\end{code}

Либо, в корне второй стоит метка \AgdaInductiveConstructor{Skip}

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{s} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{s} \AgdaDatatype{∥} \AgdaInductiveConstructor{Skip}\<%
\end{code}

Либо, рассматриваемые формы не являются листьями и их соответствующие
поддеревья совместны

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Branch-∥} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{L1} \AgdaBound{R1} \AgdaBound{L2} \AgdaBound{R2} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{L1} \AgdaDatatype{∥} \AgdaBound{L2} \AgdaSymbol{→} \AgdaBound{R1} \AgdaDatatype{∥} \AgdaBound{R2} \<[56]%
\>[56]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{→} \AgdaInductiveConstructor{Branch} \AgdaBound{L1} \AgdaBound{R1} \AgdaDatatype{∥} \AgdaInductiveConstructor{Branch} \AgdaBound{L2} \AgdaBound{R2}\<%
\end{code}
    
\subsection{Патч}

Определим патч аналогично тому, как это делалось в случае с векторами.
Патч может:

\begin{code}%
\>\AgdaKeyword{data} \AgdaDatatype{Patch} \AgdaSymbol{:} \AgdaDatatype{Form} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\end{code}

Ничего не менять

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{I} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaInductiveConstructor{Skip}\<%
\end{code}

Либо, заменить какое-то поддерево на другое поддерево

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{⟨\_⇒\_⟩} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{from} \AgdaBound{to} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Patch} \AgdaInductiveConstructor{Take}\<%
\end{code}

Либо, что-то сделать в поддеревьях

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{⟨\_∧\_⟩} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{sl} \AgdaBound{sr} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{left} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{sl}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{right} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{sr}\AgdaSymbol{)}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{→} \AgdaDatatype{Patch} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch} \AgdaBound{sl} \AgdaBound{sr}\AgdaSymbol{)}\<%
\end{code}

\begin{figure}
  \centering
  \begin{subfigure}[b]{0.65\textwidth}
    \centering
    \begin{tikzpicture}
      \node[treev,font=\small] (from) {a}
      child {node[treev,font=\small,yshift=7mm] {b}
      }
      child[missing] {}
      ;
      \node[fit=(from)(from-1),inner sep=0,outer sep=0] (whole from) {};

      \node[treev,font=\small, right=4mm of from] (to) {c}
      child[missing] {}
      child {node[treev,font=\small,yshift=7mm] {d}     
      }
      ;
      \node[fit=(to)(to-2),inner sep=0,outer sep=0] (whole to){};
      \path[treearr] (whole from) -- (whole to); 

      \node[outer sep=0,fit=(whole from)(whole to),draw=black] (patch){};
      \begin{pgfonlayer}{background}
        \node [fill=yellow,fit=(whole from)(whole to)] {};
      \end{pgfonlayer}
      
      \node[treev,font=\small,above right=of patch] (tt) {};
      \path[treearr] (tt) -- (patch);
      
      \node[treev,font=\small,below right=of tt] (tr) {};
      \path[treearr] (tt) -- (tr);
      
      \node[treev,font=\small,below left=of tr] (from2) {e};
      \node[right=4mm of from2] (to2) {$\varepsilon$};
      \path[treearr] (from2) -- (to2);

      \node[outer sep=0,fit=(from2)(to2),draw=black] (patch2){};
      \begin{pgfonlayer}{background}
        \node [fill=yellow,fit=(from2)(to2)] {};
      \end{pgfonlayer}
      
      \path[treearr] (tr) -- (patch2);
      
      \node[below right=of tr,xshift=-7mm,yshift=2.5mm] (trr) {};
      \path[treearr] (tr) -- (trr);
    \end{tikzpicture}
    \caption{Патч для дерева}
  \end{subfigure}
  \begin{subfigure}[b]{0.3\textwidth}
    \centering
    \begin{tikzpicture}
      \node[treev] {}
      child[treearr] {node[treev,fill=patchform] {}
      }
      child[treearr] {node[treev] {}
        child[treearr] {node[treev,fill=patchform] {}
        }
        child[treearr] {node[treev,fill=green] {}
        }
      }
      ;
    \end{tikzpicture}
    \caption{Его форма}
  \end{subfigure}
  \caption{Пример патча для дерева}
  \label{fig:tree-patch-example}
\end{figure}

Пример патча и его формы можно видеть на
рисунке~\ref{fig:tree-patch-example}.
    
Основное отличие от патча над векторами заключается в том, что здесь
может меняться размер структуры: в векторе один символ всегда
заменялся на один символ. Здесь же поддерево произвольного размера
заменяется также на поддерево произвольного размера.

Когда заданный патч может быть применён к заданному дереву?

\begin{code}%
\>\AgdaKeyword{data} \AgdaDatatype{\_⊏\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Patch} \AgdaBound{s} \AgdaSymbol{→} \AgdaDatatype{Tree} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\end{code}

Пустой патч можно применить всегда.

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{⊏-I} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{I} \AgdaDatatype{⊏} \AgdaBound{t}\<%
\end{code}

Патч, меняющий дерево на другое, можно применить только к заменяемому
дереву.

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{⊏-⇒} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{from} \AgdaBound{to} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaDatatype{⊏} \AgdaBound{from}\<%
\end{code}

Если патчи применимы к поддеревьям, то из них можно собрать патч,
применимый к целому дереву.

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{⊏-∧} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{sl} \AgdaBound{sr} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{pl} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{sl}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{pr} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{sr}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{tl} \AgdaBound{tr} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{\}}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{→} \AgdaBound{pl} \AgdaDatatype{⊏} \AgdaBound{tl} \AgdaSymbol{→} \AgdaBound{pr} \AgdaDatatype{⊏} \AgdaBound{tr} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{pl} \AgdaInductiveConstructor{∧} \AgdaBound{pr} \AgdaInductiveConstructor{⟩} \AgdaDatatype{⊏} \AgdaInductiveConstructor{Branch} \AgdaBound{tl} \AgdaBound{tr}\<%
\end{code}

Напишем функцию применения патча. Она принимает патч, дерево и 
доказательство того, что этот патч можно применить.

\begin{code}%
\>\AgdaFunction{patch} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{p} \AgdaDatatype{⊏} \AgdaBound{t} \AgdaSymbol{→} \AgdaDatatype{Tree}\<%
\end{code}

Применение пустого патча ничего не делает.

\begin{code}%
\>\AgdaFunction{patch} \AgdaInductiveConstructor{I} \AgdaBound{t} \AgdaSymbol{(}\AgdaInductiveConstructor{⊏-I} \AgdaSymbol{.}\AgdaBound{t}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaBound{t}\<%
\end{code}

Замена дерева заменяет дерево. % (!)

\begin{code}%
\>\AgdaFunction{patch} \AgdaInductiveConstructor{⟨} \AgdaSymbol{.}\AgdaBound{t} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaBound{t} \AgdaSymbol{(}\AgdaInductiveConstructor{⊏-⇒} \AgdaSymbol{.}\AgdaBound{t} \AgdaSymbol{.}\AgdaBound{to}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaBound{to}\<%
\end{code}

Применить под-патчи к поддеревьям.

\begin{code}%
\>\AgdaFunction{patch} \AgdaInductiveConstructor{⟨} \AgdaBound{pl} \AgdaInductiveConstructor{∧} \AgdaBound{pr} \AgdaInductiveConstructor{⟩} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch} \AgdaBound{tl} \AgdaBound{tr}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{⊏-∧} \AgdaBound{l-a} \AgdaBound{r-a}\AgdaSymbol{)} \AgdaSymbol{=} \<[49]%
\>[49]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Branch} \AgdaSymbol{(}\AgdaFunction{patch} \AgdaBound{pl} \AgdaBound{tl} \AgdaBound{l-a}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{patch} \AgdaBound{pr} \AgdaBound{tr} \AgdaBound{r-a}\AgdaSymbol{)}\<%
\end{code}

\subsection{Эквивалентность патчей}

Будем называть два патча эквивалентными, если из того, что один из
патчей можно применить к данной ревизии следует, что можно применить и
второй, и результаты после применения совпадут. Прежде чем вводить,
Непосредственно, Эквивалентность, введём отношение, которое можно
назвать \emph{не хуже, чем}:

\begin{code}%
\>\AgdaFunction{\_⟶\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaFunction{\_⟶\_} \AgdaSymbol{\{}\AgdaBound{n}\AgdaSymbol{\}} \AgdaBound{p₁} \AgdaBound{p₂} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁-x} \AgdaSymbol{:} \AgdaBound{p₁} \AgdaDatatype{⊏} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaRecord{Σ} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaDatatype{⊏} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{(λ} \AgdaBound{p₂-x} \AgdaSymbol{→} \<[43]%
\>[43]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{patch} \AgdaBound{p₁} \AgdaBound{x} \AgdaBound{p₁-x} \AgdaDatatype{≡} \AgdaFunction{patch} \AgdaBound{p₂} \AgdaBound{x} \AgdaBound{p₂-x}\AgdaSymbol{))}\<%
\end{code}

\AgdaBound{p₁} \AgdaFunction{⋀} \AgdaBound{p₂}: область определения
\AgdaBound{p₂} является надмножеством области определения
\AgdaBound{p₂} и на общей области определения результаты применения
патча совпадают.

Определим эквивалентность как взаимовложенность областей определения
и равенство на общей области опеределения.

\begin{code}%
\>\AgdaFunction{\_⟷\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{f₁} \AgdaBound{f₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{f₁}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{f₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaBound{p₁} \AgdaFunction{⟷} \AgdaBound{p₂} \AgdaSymbol{=} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⟶} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaRecord{∧} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaFunction{⟶} \AgdaBound{p₁}\AgdaSymbol{)}\<%
\end{code}

Стоит обратить внимание, что следующее определение, несмотря на то,
что кажется корректным, таковым не является: отсутствует гарантия, что
области определения патчей совпадают.

\begin{code}%
\>\AgdaFunction{\_⟷-bad\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \<[27]%
\>[27]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaBound{p₁} \AgdaFunction{⟷-bad} \AgdaBound{p₂} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaSymbol{(}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁⊏x} \AgdaSymbol{:} \AgdaBound{p₁} \AgdaDatatype{⊏} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂⊏x} \AgdaSymbol{:} \AgdaBound{p₂} \AgdaDatatype{⊏} \AgdaBound{x}\AgdaSymbol{)} \<[63]%
\>[63]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaFunction{patch} \AgdaBound{p₁} \AgdaBound{x} \AgdaBound{p₁⊏x} \AgdaDatatype{≡} \AgdaFunction{patch} \AgdaBound{p₂} \AgdaBound{x} \AgdaBound{p₂⊏x}\<%
\end{code}

Например, согласно этому неправильному определению будут эквивалентны:

\begin{code}%
\>\AgdaFunction{⟷-bad-test} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{a} \AgdaBound{b} \AgdaBound{c} \AgdaBound{d}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{a} \AgdaFunction{≠} \AgdaBound{c} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{a} \AgdaInductiveConstructor{⇒} \AgdaBound{b} \AgdaInductiveConstructor{⟩} \AgdaFunction{⟷-bad} \AgdaInductiveConstructor{⟨} \AgdaBound{c} \AgdaInductiveConstructor{⇒} \AgdaBound{d} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⟷-bad-test} \AgdaBound{a≠c} \AgdaBound{a} \AgdaSymbol{(}\AgdaInductiveConstructor{⊏-⇒} \AgdaSymbol{.}\AgdaBound{a} \AgdaSymbol{\_)} \AgdaSymbol{(}\AgdaInductiveConstructor{⊏-⇒} \AgdaSymbol{.}\AgdaBound{a} \AgdaSymbol{\_)} \AgdaSymbol{=} \AgdaFunction{⊥-elim} \AgdaSymbol{(}\AgdaBound{a≠c} \AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\end{code}

Для правильного отношения выполняются свойства отношения
эквивалентности:

\begin{itemize}
\item Рефлексивность:

\begin{code}%
\>\AgdaFunction{⟷-refl} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{p} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{p} \AgdaFunction{⟷} \AgdaBound{p}\<%
\\
\>\AgdaFunction{⟷-refl} \AgdaBound{p} \AgdaSymbol{=} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaBound{x} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{refl}\AgdaSymbol{)} \AgdaInductiveConstructor{,} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaBound{x} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{refl}\AgdaSymbol{)}\<%
\end{code}

\item Симметричность:

\begin{code}%
\>\AgdaFunction{⟷-sym} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⟷} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaFunction{⟷} \AgdaBound{p₁}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{⟷-sym} \AgdaSymbol{(}\AgdaBound{1⟶2} \AgdaInductiveConstructor{,} \AgdaBound{2⟶1}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaSymbol{(}\AgdaBound{2⟶1} \AgdaInductiveConstructor{,} \AgdaBound{1⟶2}\AgdaSymbol{)}\<%
\end{code}

\item Транзитивность:

\begin{code}%
\>\AgdaFunction{⟶-trans} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaBound{s₃} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \<[28]%
\>[28]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}\{}\AgdaBound{p₃} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₃}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⟶} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaFunction{⟶} \AgdaBound{p₃}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⟶} \AgdaBound{p₃}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{⟶-trans} \AgdaSymbol{\{p₁} \AgdaSymbol{=} \AgdaBound{p₁}\AgdaSymbol{\}\{}\AgdaBound{p₂}\AgdaSymbol{\}\{}\AgdaBound{p₃}\AgdaSymbol{\}} \AgdaBound{1⟶2} \AgdaBound{2⟶3} \AgdaSymbol{\{}\AgdaBound{x}\AgdaSymbol{\}} \AgdaBound{p⊏x} \<[42]%
\>[42]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{with} \AgdaFunction{patch} \AgdaBound{p₁} \AgdaBound{x} \AgdaBound{p⊏x} \AgdaSymbol{|} \AgdaBound{1⟶2} \AgdaBound{p⊏x} \<[32]%
\>[32]\<%
\\
\>\AgdaSymbol{...} \AgdaSymbol{|} \AgdaSymbol{.\_} \AgdaSymbol{|} \AgdaBound{p₂⊏x} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{refl} \AgdaSymbol{=} \AgdaBound{2⟶3} \AgdaBound{p₂⊏x}\<%
\\
%
\\
\>\AgdaFunction{⟷-trans} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaBound{s₃} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \<[28]%
\>[28]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}\{}\AgdaBound{p₃} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₃}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⟷} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaFunction{⟷} \AgdaBound{p₃}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⟷} \AgdaBound{p₃}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{⟷-trans} \AgdaSymbol{(}\AgdaBound{1⟶2} \AgdaInductiveConstructor{,} \AgdaBound{2⟶1}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{2⟶3} \AgdaInductiveConstructor{,} \AgdaBound{3⟶2}\AgdaSymbol{)} \AgdaSymbol{=} \<[34]%
\>[34]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaFunction{⟶-trans} \AgdaBound{1⟶2} \AgdaBound{2⟶3}\AgdaSymbol{)} \AgdaInductiveConstructor{,} \AgdaSymbol{(}\AgdaFunction{⟶-trans} \AgdaBound{3⟶2} \AgdaBound{2⟶1}\AgdaSymbol{)}\<%
\end{code}

\end{itemize}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{⟶-branch} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{L1} \AgdaBound{L2} \AgdaBound{R1} \AgdaBound{R2} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{\{}\AgdaBound{l₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{L1}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{l₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{L2}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{r₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{R1}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{r₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{R2}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{l₁} \AgdaFunction{⟶} \AgdaBound{l₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{r₁} \AgdaFunction{⟶} \AgdaBound{r₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{l₁} \AgdaInductiveConstructor{∧} \AgdaBound{r₁} \AgdaInductiveConstructor{⟩} \AgdaFunction{⟶} \AgdaInductiveConstructor{⟨} \AgdaBound{l₂} \AgdaInductiveConstructor{∧} \AgdaBound{r₂} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⟶-branch} \AgdaSymbol{\{l₁} \AgdaSymbol{=} \AgdaBound{l₁}\AgdaSymbol{\}\{}\AgdaBound{l₂}\AgdaSymbol{\}\{}\AgdaBound{r₁}\AgdaSymbol{\}\{}\AgdaBound{r₂}\AgdaSymbol{\}} \AgdaBound{l₁⟶l₂} \AgdaBound{r₁⟶r₂} \AgdaSymbol{(}\AgdaInductiveConstructor{⊏-∧} \AgdaSymbol{\{tl} \AgdaSymbol{=} \AgdaBound{tl}\AgdaSymbol{\}\{}\AgdaBound{tr}\AgdaSymbol{\}} \AgdaBound{l⊏L} \AgdaBound{r⊏R}\AgdaSymbol{)} \<[71]%
\>[71]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{with} \AgdaFunction{patch} \AgdaBound{l₁} \AgdaBound{tl} \AgdaBound{l⊏L} \AgdaSymbol{|} \AgdaBound{l₁⟶l₂} \AgdaBound{l⊏L} \<[35]%
\>[35]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{|} \AgdaFunction{patch} \AgdaBound{r₁} \AgdaBound{tr} \AgdaBound{r⊏R} \AgdaSymbol{|} \AgdaBound{r₁⟶r₂} \AgdaBound{r⊏R}\<%
\\
\>\AgdaSymbol{...} \AgdaSymbol{|} \AgdaSymbol{.\_} \AgdaSymbol{|} \AgdaBound{l₂⊏L} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{refl} \AgdaSymbol{|} \AgdaSymbol{.\_} \AgdaSymbol{|} \AgdaBound{r₂⊏R} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{refl} \AgdaSymbol{=} \<[44]%
\>[44]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{⊏-∧} \AgdaBound{l₂⊏L} \AgdaBound{r₂⊏R} \AgdaInductiveConstructor{,} \AgdaInductiveConstructor{refl}\<%
\\
%
\\
\>\AgdaFunction{⟷-branch} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{L1} \AgdaBound{L2} \AgdaBound{R1} \AgdaBound{R2} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{\{}\AgdaBound{l₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{L1}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{l₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{L2}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{r₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{R1}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{r₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{R2}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{l₁} \AgdaFunction{⟷} \AgdaBound{l₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{r₁} \AgdaFunction{⟷} \AgdaBound{r₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{l₁} \AgdaInductiveConstructor{∧} \AgdaBound{r₁} \AgdaInductiveConstructor{⟩} \AgdaFunction{⟷} \AgdaInductiveConstructor{⟨} \AgdaBound{l₂} \AgdaInductiveConstructor{∧} \AgdaBound{r₂} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⟷-branch} \AgdaSymbol{(}\AgdaBound{l₁⟶l₂} \AgdaInductiveConstructor{,} \AgdaBound{l₂⟶l₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{r₁⟶r₂} \AgdaInductiveConstructor{,} \AgdaBound{r₂⟶r₁}\AgdaSymbol{)} \AgdaSymbol{=} \<[43]%
\>[43]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaFunction{⟶-branch} \AgdaBound{l₁⟶l₂} \AgdaBound{r₁⟶r₂}\AgdaSymbol{)} \AgdaInductiveConstructor{,} \AgdaSymbol{(}\AgdaFunction{⟶-branch} \AgdaBound{l₂⟶l₁} \AgdaBound{r₂⟶r₁}\AgdaSymbol{)}\<%
\end{code}
}

\subsection{Объединение неконфликтующих патчей}

\begin{figure}
  \centering
    \begin{tikzpicture}
      [level distance=1cm]
      \node[treev] (lhsr) {}
      child[treearr] {node[treev] {}
        child[treearr] {node[rectangle, minimum height=1cm] {}
        }
        child[treearr] {node[fill=yellow,rectangle,draw=black] {$A \to B$}
        }
      }
      child[treearr] {node[rectangle, minimum height=1cm] {}
      };
      \node[fit=(lhsr)(lhsr-1)(lhsr-1-1)(lhsr-1-2)(lhsr-2)] (lhs) {};

      \node[right=0 of lhs,font=\Huge] (and) {$\wedge$};

      \node[treev, right=2cm of lhsr] (rhsr) {}
      child[treearr] {node[rectangle, minimum height=1cm] {}
      }
      child[treearr] {node[fill=yellow,rectangle,draw=black] {$C \to D$}
      };
      \node[fit=(rhsr)(rhsr-1)(lhsr-2)] (rhs) {};

      \node[right=3.3cm of lhs,font=\Huge] (eq) {$=$};

      \node[treev, right=3.4cm of rhsr] (lhsr) {}
      child[treearr] {node[treev] {}
        child[treearr] {node[rectangle, minimum height=1cm] {}
        }
        child[treearr] {node[fill=yellow,rectangle,draw=black] {$A \to B$}
        }
      }
      child[treearr] {node[fill=yellow,rectangle,draw=black] {$C \to D$}
      };
    \end{tikzpicture}
  \caption{Неконфликтующее объединение патчей}
  \label{fig:tree-merge-nonconflict}
\end{figure}

Перед реализацией объединения понадобится несколько вспомогательных
функций. Объединение двух совместных форм:

\begin{code}%
\>\AgdaFunction{\_\textasciicircum\_} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaBound{sl} \AgdaBound{sr} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{sl} \AgdaDatatype{∥} \AgdaBound{sr} \AgdaSymbol{→} \AgdaDatatype{Form}\<%
\\
\>\AgdaFunction{\_\textasciicircum\_} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip} \AgdaBound{sr} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaBound{sr}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaBound{sr}\<%
\\
\>\AgdaFunction{\_\textasciicircum\_} \AgdaBound{sl} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaBound{sl}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaBound{sl}\<%
\\
\>\AgdaFunction{\_\textasciicircum\_} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch} \AgdaBound{L1} \AgdaBound{R1}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch} \AgdaBound{L2} \AgdaBound{R2}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{pl} \AgdaBound{pr}\AgdaSymbol{)} \AgdaSymbol{=} \<[53]%
\>[53]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Branch} \AgdaSymbol{((}\AgdaBound{L1} \AgdaFunction{\textasciicircum} \AgdaBound{L2}\AgdaSymbol{)} \AgdaBound{pl}\AgdaSymbol{)} \AgdaSymbol{((}\AgdaBound{R1} \AgdaFunction{\textasciicircum} \AgdaBound{R2}\AgdaSymbol{)} \AgdaBound{pr}\AgdaSymbol{)}\<%
\end{code}

И её более удобная для использования копия:

\begin{code}%
\>\AgdaFunction{unite} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{f₁} \AgdaBound{f₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{f₁} \AgdaDatatype{∥} \AgdaBound{f₂} \AgdaSymbol{→} \AgdaDatatype{Form}\<%
\\
\>\AgdaFunction{unite} \AgdaSymbol{\{}\AgdaBound{f₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{f₂}\AgdaSymbol{\}} \AgdaBound{p} \AgdaSymbol{=} \AgdaSymbol{(}\AgdaBound{f₁} \AgdaFunction{\textasciicircum} \AgdaBound{f₂}\AgdaSymbol{)} \AgdaBound{p}\<%
\end{code}

Непосредственно, объеденение~(рисунок~\ref{fig:tree-merge-nonconflict}):

\begin{code}%
\>\AgdaFunction{\_⋀\_} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{s₁∥s₂} \AgdaSymbol{:} \AgdaBound{s₁} \AgdaDatatype{∥} \AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaDatatype{Patch} \AgdaSymbol{(}\AgdaFunction{unite} \AgdaBound{s₁∥s₂}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{\_⋀\_} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{\_⋀\_} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{\_⋀\_} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{\_⋀\_} \AgdaInductiveConstructor{I} \AgdaSymbol{(}\AgdaInductiveConstructor{⟨\_∧\_⟩} \AgdaSymbol{\{}\AgdaBound{sl}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{sr}\AgdaSymbol{\}} \AgdaBound{pl} \AgdaBound{pr}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.(}\AgdaInductiveConstructor{Branch} \AgdaBound{sl} \AgdaBound{sr}\AgdaSymbol{)}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{⟨} \AgdaBound{pl} \AgdaInductiveConstructor{∧} \AgdaBound{pr} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{\_⋀\_} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{\_⋀\_} \AgdaSymbol{(}\AgdaInductiveConstructor{⟨\_∧\_⟩} \AgdaSymbol{\{}\AgdaBound{sl}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{sr}\AgdaSymbol{\}} \AgdaBound{pl} \AgdaBound{pr}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.(}\AgdaInductiveConstructor{Branch} \AgdaBound{sl} \AgdaBound{sr}\AgdaSymbol{)}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{⟨} \AgdaBound{pl} \AgdaInductiveConstructor{∧} \AgdaBound{pr} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{\_⋀\_} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{⟨} \AgdaBound{p₃} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{s₁∥s₂} \AgdaBound{s₃∥s₄}\AgdaSymbol{)} \AgdaSymbol{=} \<[53]%
\>[53]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{⟨} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⋀} \AgdaBound{p₃}\AgdaSymbol{)} \AgdaBound{s₁∥s₂} \AgdaInductiveConstructor{∧} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaFunction{⋀} \AgdaBound{p₄}\AgdaSymbol{)} \AgdaBound{s₃∥s₄} \AgdaInductiveConstructor{⟩}\<%
\end{code}

Во всех случаях, кроме последнего, один из операндов равен
\AgdaInductiveConstructor{I}, поэтому в качестве ответа берётся другой
операнд. В последнем же случае делаются два рекурсивных запуска от 
пар левых и правых поддеревьев и результаты берутся как левое и правое
поддерево результата, соответственно.
  
Докажем некоторые свойства операции \AgdaFunction{\_⋀\_}. Поставим
целью доказать коммутативность и ассоциативность этой операции.
Докажем перед этим несколько лемм.

Симметричность отношения совместности форм. Доказывается индукцией
по структуре \AgdaBound{s₁} \AgdaFunction{∥} \AgdaBound{s₂}.

\begin{code}%
\>\AgdaFunction{∥-sym} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{s₁} \AgdaDatatype{∥} \AgdaBound{s₂} \AgdaSymbol{→} \AgdaBound{s₂} \AgdaDatatype{∥} \AgdaBound{s₁}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{∥-sym} \AgdaSymbol{\{}\AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{s₂}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{✶∥∅} \AgdaBound{s₂}\<%
\\
\>\AgdaFunction{∥-sym} \AgdaSymbol{\{}\AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{∅∥✶} \AgdaBound{s₁}\<%
\\
\>\AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{s₁∥s₂} \AgdaBound{s₁∥s₃}\AgdaSymbol{)} \AgdaSymbol{=} \<[31]%
\>[31]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Branch-∥} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₁∥s₂}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₁∥s₃}\AgdaSymbol{)}\<%
\end{code}
}

Если три формы попарно совместны, то третья совместна с объединением
первых двух.

\begin{code}%
\>\AgdaFunction{lemma-∥-unite} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaBound{s₃} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \<[34]%
\>[34]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{s₁∥s₂} \AgdaSymbol{:} \AgdaBound{s₁} \AgdaDatatype{∥} \AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{s₂} \AgdaDatatype{∥} \AgdaBound{s₃} \AgdaSymbol{→} \AgdaBound{s₁} \AgdaDatatype{∥} \AgdaBound{s₃}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaFunction{unite} \AgdaBound{s₁∥s₂} \AgdaDatatype{∥} \AgdaBound{s₃}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{lemma-∥-unite} \AgdaSymbol{\{}\AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{s₂}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaBound{s₂}\AgdaSymbol{)} \AgdaBound{s₂∥s₃} \AgdaBound{s₁∥s₃} \AgdaSymbol{=} \AgdaBound{s₂∥s₃}\<%
\\
\>\AgdaFunction{lemma-∥-unite} \AgdaSymbol{\{}\AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaBound{s₁}\AgdaSymbol{)} \AgdaBound{s₂∥s₃} \AgdaBound{s₁∥s₃} \AgdaSymbol{=} \AgdaBound{s₁∥s₃}\<%
\\
\>\AgdaFunction{lemma-∥-unite} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaSymbol{\{}\AgdaBound{L1}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{R1}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L2}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{R2}\AgdaSymbol{\}} \AgdaBound{L1∥L2} \AgdaBound{R1∥R2}\AgdaSymbol{)} \<[57]%
\>[57]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.(}\AgdaInductiveConstructor{Branch} \AgdaBound{L2} \AgdaBound{R2}\AgdaSymbol{)}\AgdaSymbol{)} \AgdaBound{s₁∥s₃} \<[30]%
\>[30]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{=} \AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch} \AgdaSymbol{((}\AgdaBound{L1} \AgdaFunction{\textasciicircum} \AgdaBound{L2}\AgdaSymbol{)} \AgdaBound{L1∥L2}\AgdaSymbol{)} \AgdaSymbol{((}\AgdaBound{R1} \AgdaFunction{\textasciicircum} \AgdaBound{R2}\AgdaSymbol{)} \AgdaBound{R1∥R2}\AgdaSymbol{))}\<%
\\
\>\AgdaFunction{lemma-∥-unite} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{L1∥L2} \AgdaBound{R1∥R2}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{s₂∥s₃} \AgdaBound{s₂∥s₄}\AgdaSymbol{)} \<[60]%
\>[60]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{s₁∥s₃} \AgdaBound{s₁∥s₄}\AgdaSymbol{)} \<[25]%
\>[25]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{=} \AgdaInductiveConstructor{Branch-∥} \AgdaSymbol{(}\AgdaFunction{lemma-∥-unite} \AgdaBound{L1∥L2} \AgdaBound{s₂∥s₃} \AgdaBound{s₁∥s₃}\AgdaSymbol{)}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{lemma-∥-unite} \AgdaBound{R1∥R2} \AgdaBound{s₂∥s₄} \AgdaBound{s₁∥s₄}\AgdaSymbol{)}\<%
\end{code}
}

Два раза применённая симметрия для совместных форм вернёт абсолютно то
же самое, что было изначально.

\begin{code}%
\>\AgdaFunction{∥-sym²≡id} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{s₁∥s₂} \AgdaSymbol{:} \AgdaBound{s₁} \AgdaDatatype{∥} \AgdaBound{s₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaBound{s₁∥s₂} \AgdaDatatype{≡} \AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₁∥s₂}\AgdaSymbol{)}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{∥-sym²≡id} \AgdaSymbol{\{}\AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{s₂}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\\
\>\AgdaFunction{∥-sym²≡id} \AgdaSymbol{\{}\AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\\
\>\AgdaFunction{∥-sym²≡id} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{L1∥L2} \AgdaBound{R1∥R2}\AgdaSymbol{)} \<[33]%
\>[33]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{with} \AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{L1∥L2}\AgdaSymbol{)} \AgdaSymbol{|} \AgdaFunction{∥-sym²≡id} \AgdaBound{L1∥L2}\<%
\\
\>[2]\AgdaIndent{5}{}\<[5]%
\>[5]\AgdaSymbol{|} \AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{R1∥R2}\AgdaSymbol{)} \AgdaSymbol{|} \AgdaFunction{∥-sym²≡id} \AgdaBound{R1∥R2}\<%
\\
\>\AgdaFunction{∥-sym²≡id} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaSymbol{.}\AgdaBound{i1} \AgdaSymbol{.}\AgdaBound{i2}\AgdaSymbol{)} \AgdaSymbol{|} \AgdaBound{i1} \AgdaSymbol{|} \AgdaInductiveConstructor{refl} \AgdaSymbol{|} \AgdaBound{i2} \AgdaSymbol{|} \AgdaInductiveConstructor{refl} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\end{code}
}
  
Докажем Коммутативность операции \AgdaFunction{\_⋀\_}. Доказательство
ведётся по индукции по структуре патчей и доказательства совместности
их форм.

\begin{code}%
\>\AgdaFunction{⋀-comm} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{s₁∥s₂} \AgdaSymbol{:} \AgdaBound{s₁} \AgdaDatatype{∥} \AgdaBound{s₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{((}\AgdaBound{p₁} \AgdaFunction{⋀} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaBound{s₁∥s₂}\AgdaSymbol{)} \AgdaFunction{⟷} \AgdaSymbol{((}\AgdaBound{p₂} \AgdaFunction{⋀} \AgdaBound{p₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₁∥s₂}\AgdaSymbol{))}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{⋀-comm} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-comm} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-comm} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-comm} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-comm} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-comm} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-comm} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{L1∥L2} \AgdaBound{R1∥R2}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{l₁} \AgdaInductiveConstructor{∧} \AgdaBound{r₁} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{⟨} \AgdaBound{l₂} \AgdaInductiveConstructor{∧} \AgdaBound{r₂} \AgdaInductiveConstructor{⟩} \<[54]%
\>[54]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{=} \AgdaFunction{⟷-branch} \AgdaFunction{L} \AgdaFunction{R}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{where}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{L} \AgdaSymbol{=} \AgdaFunction{⋀-comm} \AgdaBound{L1∥L2} \AgdaBound{l₁} \AgdaBound{l₂}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{R} \AgdaSymbol{=} \AgdaFunction{⋀-comm} \AgdaBound{R1∥R2} \AgdaBound{r₁} \AgdaBound{r₂}\<%
\end{code}
}

Докажем ассоциативность операции \AgdaFunction{\_⋀\_}. Несмотря на
громоздкость этой формулировки, здесь просто записано, что $(p_1
\wedge p_2) \wedge p_3 \longleftrightarrow p_1 \wedge (p_2 \wedge
p_3)$. Остальной мусор появляется из-за того, что для применения
операции нужно также явно передавать доказательство того, что её
применить можно. Доказательство ведётся по индукции, в нём используется 
кажущаяся бесполезной функций \AgdaFunction{∥-sym²≡id}.

\begin{code}%
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaBound{s₃} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \<[30]%
\>[30]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{s₁∥s₂} \AgdaSymbol{:} \AgdaBound{s₁} \AgdaDatatype{∥} \AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{s₂∥s₃} \AgdaSymbol{:} \AgdaBound{s₂} \AgdaDatatype{∥} \AgdaBound{s₃}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{s₁∥s₃} \AgdaSymbol{:} \AgdaBound{s₁} \AgdaDatatype{∥} \AgdaBound{s₃}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{p₃} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₃}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(((}\AgdaBound{p₁} \AgdaFunction{⋀} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaBound{s₁∥s₂}\AgdaSymbol{)} \AgdaFunction{⋀} \AgdaBound{p₃}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{lemma-∥-unite} \AgdaBound{s₁∥s₂} \AgdaBound{s₂∥s₃} \AgdaBound{s₁∥s₃}\AgdaSymbol{)} \AgdaFunction{⟷} \<[65]%
\>[65]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⋀} \AgdaSymbol{((}\AgdaBound{p₂} \AgdaFunction{⋀} \AgdaBound{p₃}\AgdaSymbol{)} \AgdaBound{s₂∥s₃}\AgdaSymbol{))} \<[29]%
\>[29]\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaFunction{lemma-∥-unite} \AgdaBound{s₂∥s₃} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₁∥s₃}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₁∥s₂}\AgdaSymbol{)))}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \<[64]%
\>[64]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{p₃} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{p₃} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \<[64]%
\>[64]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \<[64]%
\>[64]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{s₂∥s₃} \AgdaBound{s₂∥s₄}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{⟨} \AgdaBound{p₄} \AgdaInductiveConstructor{∧} \AgdaBound{p₅} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaFunction{⋀} \AgdaBound{p₄}\AgdaSymbol{)} \AgdaBound{s₂∥s₃} \AgdaInductiveConstructor{∧} \AgdaSymbol{(}\AgdaBound{p₃} \AgdaFunction{⋀} \AgdaBound{p₅}\AgdaSymbol{)} \AgdaBound{s₂∥s₄} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \<[64]%
\>[64]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{p₃} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{p₃} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \<[64]%
\>[64]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{s₁∥s₃} \AgdaBound{s₂∥s₄}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{⟨} \AgdaBound{p₃} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩} \<[75]%
\>[75]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{with} \AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₁∥s₃}\AgdaSymbol{)} \AgdaSymbol{|} \AgdaFunction{∥-sym²≡id} \AgdaBound{s₁∥s₃} \<[45]%
\>[45]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{|} \AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₂∥s₄}\AgdaSymbol{)} \AgdaSymbol{|} \AgdaFunction{∥-sym²≡id} \AgdaBound{s₂∥s₄}\<%
\\
\>\AgdaSymbol{...} \AgdaSymbol{|} \AgdaSymbol{.}\AgdaBound{s₁∥s₃} \AgdaSymbol{|} \AgdaInductiveConstructor{refl} \AgdaSymbol{|} \AgdaSymbol{.}\AgdaBound{s₂∥s₄} \AgdaSymbol{|} \AgdaInductiveConstructor{refl} \AgdaSymbol{=} \<[38]%
\>[38]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⋀} \AgdaBound{p₃}\AgdaSymbol{)} \AgdaBound{s₁∥s₃} \AgdaInductiveConstructor{∧} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaFunction{⋀} \AgdaBound{p₄}\AgdaSymbol{)} \AgdaBound{s₂∥s₄} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{I}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Take}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \<[64]%
\>[64]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{from} \AgdaInductiveConstructor{⇒} \AgdaBound{to} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.}\AgdaInductiveConstructor{Skip}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{s₁∥s₃} \AgdaBound{s₂∥s₄}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶∥∅} \AgdaSymbol{.\_}\AgdaSymbol{)} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{⟨} \AgdaBound{p₃} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{I}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{with} \AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₁∥s₃}\AgdaSymbol{)} \AgdaSymbol{|} \AgdaFunction{∥-sym²≡id} \AgdaBound{s₁∥s₃} \<[45]%
\>[45]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{|} \AgdaFunction{∥-sym} \AgdaSymbol{(}\AgdaFunction{∥-sym} \AgdaBound{s₂∥s₄}\AgdaSymbol{)} \AgdaSymbol{|} \AgdaFunction{∥-sym²≡id} \AgdaBound{s₂∥s₄}\<%
\\
\>\AgdaSymbol{...} \AgdaSymbol{|} \AgdaSymbol{.}\AgdaBound{s₁∥s₃} \AgdaSymbol{|} \AgdaInductiveConstructor{refl} \AgdaSymbol{|} \AgdaSymbol{.}\AgdaBound{s₂∥s₄} \AgdaSymbol{|} \AgdaInductiveConstructor{refl} \AgdaSymbol{=} \<[38]%
\>[38]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaFunction{⋀} \AgdaBound{p₃}\AgdaSymbol{)} \AgdaBound{s₁∥s₃} \AgdaInductiveConstructor{∧} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaFunction{⋀} \AgdaBound{p₄}\AgdaSymbol{)} \AgdaBound{s₂∥s₄} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋀-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{L1∥L2} \AgdaBound{R1∥R2}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{L2∥L3} \AgdaBound{R2∥R3}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-∥} \AgdaBound{L1∥L3} \AgdaBound{R1∥R3}\AgdaSymbol{)} \<[77]%
\>[77]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{⟨} \AgdaBound{p₃} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩} \AgdaInductiveConstructor{⟨} \AgdaBound{p₅} \AgdaInductiveConstructor{∧} \AgdaBound{p₆} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \<[40]%
\>[40]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{⟷-branch} \<[13]%
\>[13]\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{(}\AgdaFunction{⋀-assoc} \AgdaBound{L1∥L2} \AgdaBound{L2∥L3} \AgdaBound{L1∥L3} \AgdaBound{p₁} \AgdaBound{p₃} \AgdaBound{p₅}\AgdaSymbol{)} \<[43]%
\>[43]\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{(}\AgdaFunction{⋀-assoc} \AgdaBound{R1∥R2} \AgdaBound{R2∥R3} \AgdaBound{R1∥R3} \AgdaBound{p₂} \AgdaBound{p₄} \AgdaBound{p₆}\AgdaSymbol{)}\<%
\end{code}
}


\subsection{Объединение конфликтующих патчей}

\begin{figure}
  \centering
  \begin{tikzpicture}
    [level distance=1cm,outer sep=0]
    \node[treev] (lhsr) {}
    child[treearr] {node[treev] {}
      child[treearr] {node[fill=yellow,rectangle,draw=black] {$E \to F$}
      }
      child[treearr] {node[fill=yellow,rectangle,draw=black,xshift=6mm] {$G \to H$}
      }
    }
    child[treearr] {node[rectangle, minimum height=1cm] {}
    };
    \node[fit=(lhsr)(lhsr-1)(lhsr-1-1)(lhsr-1-2)(lhsr-2)] (lhs) {};

    \node[right=-4mm of lhs,font=\huge] (and) {$\ggg$};

    \node[treev, right=3.3cm of lhsr] (rhsr) {}
    child[treearr] {node[treev] {}
      child[treearr] {node[rectangle, minimum height=1cm] {}
      }
      child[treearr] {node[fill=yellow,rectangle,draw=black,xshift=-2mm] {$H \to I$}
      }
    }
    child[treearr] {node[rectangle, minimum height=1cm] {}
    };
    \node[fit=(rhsr)(rhsr-1)(lhsr-2)] (rhs) {};

    \node[right=3.4cm of lhs,font=\Huge] (eq) {$=$};

    \node[treev, right=6.8cm of lhsr] {}
    child[treearr] {node[treev] {}
      child[treearr] {node[fill=yellow,rectangle,draw=black] {$E \to F$}
      }
      child[treearr] {node[fill=yellow,rectangle,draw=black,xshift=6mm] {$G \to I$}
      }
    }
    child[treearr] {node[rectangle, minimum height=1cm] {}
    };
  \end{tikzpicture}
  \caption{Конфликтующее объединение патчей}
  \label{fig:tree-merge-conflict}
\end{figure}

Аналогично векторам, введём для пары патчей отношение <<можно
применить последовательно>> \AgdaFunction{\_⋙?\_}, которое будет
означать, что второй патч можно применить после первого и он помеяет
только то, что менял первый.

\begin{code}%
\>\AgdaKeyword{data} \AgdaDatatype{\_⋙?\_} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\end{code}

Второй патч может ничего не делать.

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{p} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{p} \AgdaDatatype{⋙?} \AgdaInductiveConstructor{I}\<%
\end{code}

Либо, сразу заменять результат замены первого на что-то новое.

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Here-⋙?} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{(}\AgdaBound{t₁} \AgdaBound{t₂} \AgdaBound{t₃} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{t₁} \AgdaInductiveConstructor{⇒} \AgdaBound{t₂} \AgdaInductiveConstructor{⟩} \AgdaDatatype{⋙?} \AgdaInductiveConstructor{⟨} \AgdaBound{t₂} \AgdaInductiveConstructor{⇒} \AgdaBound{t₃} \AgdaInductiveConstructor{⟩}\<%
\end{code}

Либо, собирать из поддеревьев.

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Branch-⋙?} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaBound{s₃} \AgdaBound{s₄}\AgdaSymbol{\}} \<[30]%
\>[30]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{→} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₃} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₃}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₄} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₄}\AgdaSymbol{\}}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{L} \AgdaSymbol{:} \AgdaBound{p₁} \AgdaDatatype{⋙?} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{R} \AgdaSymbol{:} \AgdaBound{p₃} \AgdaDatatype{⋙?} \AgdaBound{p₄}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩} \AgdaDatatype{⋙?} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩}\<%
\end{code}
    
\AgdaHide{
\begin{code}%
\>\AgdaFunction{⋙?-uniq} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{?₁} \AgdaBound{?₂} \AgdaSymbol{:} \AgdaBound{p₁} \AgdaDatatype{⋙?} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{?₁} \AgdaDatatype{≡} \AgdaBound{?₂}\<%
\\
\>\AgdaFunction{⋙?-uniq} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaBound{p₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.}\AgdaBound{p₁}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\\
\>\AgdaFunction{⋙?-uniq} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaBound{t₁} \AgdaBound{t₂} \AgdaBound{t₃}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaSymbol{.}\AgdaBound{t₁} \AgdaSymbol{.}\AgdaBound{t₂} \AgdaSymbol{.}\AgdaBound{t₃}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\\
\>\AgdaFunction{⋙?-uniq} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{?₁} \AgdaBound{?₂}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{?₃} \AgdaBound{?₄}\AgdaSymbol{)} \<[44]%
\>[44]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{rewrite} \AgdaFunction{⋙?-uniq} \AgdaBound{?₁} \AgdaBound{?₃} \AgdaSymbol{|} \AgdaFunction{⋙?-uniq} \AgdaBound{?₂} \AgdaBound{?₄} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\end{code}
}

Определим, собственно, последовательное применение патчей.

\begin{code}%
\>\AgdaFunction{⋙} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaBound{p₁} \AgdaDatatype{⋙?} \AgdaBound{p₂} \AgdaSymbol{→} \AgdaDatatype{Patch} \AgdaBound{s₁}\<%
\end{code}

Если второй патч ничего не делает, то результат~--- первый патч.

\begin{code}%
\>\AgdaFunction{⋙} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaBound{p}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaBound{p}\<%
\end{code}

Если второй патч ломает то, что сделал первый~--- то результатом будет
преобразование из того, что ожидал первый в то, что делает второй.

\begin{code}%
\>\AgdaFunction{⋙} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaBound{t₁} \AgdaBound{t₂} \AgdaBound{t₃}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{⟨} \AgdaBound{t₁} \AgdaInductiveConstructor{⇒} \AgdaBound{t₃} \AgdaInductiveConstructor{⟩}\<%
\end{code}

Рекурсивно запуститься от поддеревьев.

\begin{code}%
\>\AgdaFunction{⋙} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{p₁⋙?p₂} \AgdaBound{p₃⋙?p₄}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{⟨} \AgdaFunction{⋙} \AgdaBound{p₁⋙?p₂} \AgdaInductiveConstructor{∧} \AgdaFunction{⋙} \AgdaBound{p₃⋙?p₄} \AgdaInductiveConstructor{⟩}\<%
\end{code}

Докажем, что результат последовательного применения двух патчей
не зависит от того, как именно доказано, что их можно последовательно 
применить. Эта лемма понадобится в дальнейшем.

\begin{code}%
\>\AgdaFunction{⋙-preserves} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{?₁} \AgdaBound{?₂} \AgdaSymbol{:} \AgdaBound{p₁} \AgdaDatatype{⋙?} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaFunction{⋙} \AgdaBound{?₁} \AgdaFunction{⟷} \AgdaFunction{⋙} \AgdaBound{?₂}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{⋙-preserves} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaBound{p₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.}\AgdaBound{p₁}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaBound{p₁}\<%
\\
\>\AgdaFunction{⋙-preserves} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaBound{t₁} \AgdaBound{t₂} \AgdaBound{t₃}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaSymbol{.}\AgdaBound{t₁} \AgdaSymbol{.}\AgdaBound{t₂} \AgdaSymbol{.}\AgdaBound{t₃}\AgdaSymbol{)} \AgdaSymbol{=} \<[55]%
\>[55]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{t₁} \AgdaInductiveConstructor{⇒} \AgdaBound{t₃} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋙-preserves} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{?₁} \AgdaBound{?₂}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{?₃} \AgdaBound{?₄}\AgdaSymbol{)} \AgdaSymbol{=} \<[50]%
\>[50]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{⟷-branch} \AgdaSymbol{(}\AgdaFunction{⋙-preserves} \AgdaBound{?₁} \AgdaBound{?₃}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{⋙-preserves} \AgdaBound{?₂} \AgdaBound{?₄}\AgdaSymbol{)}\<%
\end{code}
}

Докажем ассоциативность операции \AgdaFunction{⋙}. При доказательстве
в одном из нетривиальных случаев потребовалась лемма
\AgdaFunction{⋙-preserves}, а в другом~--- рекурсивный вызов от
поддеревьев.

\begin{code}%
\>\AgdaFunction{⋙-assoc} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaBound{s₃} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₃} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₃}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{1⋙?2} \AgdaSymbol{:} \AgdaBound{p₁} \AgdaDatatype{⋙?} \AgdaBound{p₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{[1⋙2]⋙?3} \AgdaSymbol{:} \AgdaSymbol{(}\AgdaFunction{⋙} \AgdaBound{1⋙?2}\AgdaSymbol{)} \AgdaDatatype{⋙?} \AgdaBound{p₃}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{2⋙?3} \AgdaSymbol{:} \AgdaBound{p₂} \AgdaDatatype{⋙?} \AgdaBound{p₃}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{1⋙?[2⋙3]} \AgdaSymbol{:} \AgdaBound{p₁} \AgdaDatatype{⋙?} \AgdaSymbol{(}\AgdaFunction{⋙} \AgdaBound{2⋙?3}\AgdaSymbol{))}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaFunction{⋙} \AgdaBound{[1⋙2]⋙?3}\AgdaSymbol{)} \AgdaFunction{⟷} \AgdaSymbol{(}\AgdaFunction{⋙} \AgdaBound{1⋙?[2⋙3]}\AgdaSymbol{)}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{⋙-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaBound{p₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.}\AgdaBound{p₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.}\AgdaInductiveConstructor{I}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.}\AgdaBound{p₁}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaBound{p₁}\<%
\\
\>\AgdaFunction{⋙-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaBound{t₁} \AgdaBound{t₂} \AgdaBound{t₃}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.(}\AgdaInductiveConstructor{⟨} \AgdaBound{t₁} \AgdaInductiveConstructor{⇒} \AgdaBound{t₃} \AgdaInductiveConstructor{⟩}\AgdaSymbol{)}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.(}\AgdaInductiveConstructor{⟨} \AgdaBound{t₂} \AgdaInductiveConstructor{⇒} \AgdaBound{t₃} \AgdaInductiveConstructor{⟩}\AgdaSymbol{)}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaSymbol{.}\AgdaBound{t₁} \AgdaSymbol{.}\AgdaBound{t₂} \AgdaSymbol{.}\AgdaBound{t₃}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{t₁} \AgdaInductiveConstructor{⇒} \AgdaBound{t₃} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋙-assoc} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaBound{t₁} \AgdaBound{t₂} \AgdaBound{t₃}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaSymbol{.}\AgdaBound{t₁} \AgdaSymbol{.}\AgdaBound{t₃} \AgdaBound{t₄}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaSymbol{.}\AgdaBound{t₂} \AgdaSymbol{.}\AgdaBound{t₃} \AgdaSymbol{.}\AgdaBound{t₄}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{Here-⋙?} \AgdaSymbol{.}\AgdaBound{t₁} \AgdaSymbol{.}\AgdaBound{t₂} \AgdaSymbol{.}\AgdaBound{t₄}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{⟷-refl} \AgdaInductiveConstructor{⟨} \AgdaBound{t₁} \AgdaInductiveConstructor{⇒} \AgdaBound{t₄} \AgdaInductiveConstructor{⟩}\<%
\\
\>\AgdaFunction{⋙-assoc} \<[8]%
\>[8]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{1⋙?2} \AgdaBound{3⋙?4}\AgdaSymbol{)} \<[24]%
\>[24]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.(}\AgdaInductiveConstructor{⟨} \AgdaFunction{⋙} \AgdaBound{1⋙?2} \AgdaInductiveConstructor{∧} \AgdaFunction{⋙} \AgdaBound{3⋙?4} \AgdaInductiveConstructor{⟩}\AgdaSymbol{)}\AgdaSymbol{)} \<[32]%
\>[32]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{.\_}\AgdaSymbol{)} \<[12]%
\>[12]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{1⋙?[2⋙0]} \AgdaBound{3⋙?[4⋙0]}\AgdaSymbol{)} \<[32]%
\>[32]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{=} \AgdaFunction{⟷-branch} \AgdaSymbol{(}\AgdaFunction{⋙-preserves} \AgdaBound{1⋙?2} \AgdaBound{1⋙?[2⋙0]}\AgdaSymbol{)} \<[41]%
\>[41]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{⋙-preserves} \AgdaBound{3⋙?4} \AgdaBound{3⋙?[4⋙0]}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{⋙-assoc} \<[8]%
\>[8]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{1⋙?2} \AgdaBound{3⋙?4}\AgdaSymbol{)} \<[24]%
\>[24]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{[1⋙2]⋙?5} \AgdaBound{[3⋙4]⋙?6}\AgdaSymbol{)} \<[32]%
\>[32]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{2⋙?5} \AgdaBound{4⋙?6}\AgdaSymbol{)} \<[24]%
\>[24]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaInductiveConstructor{Branch-⋙?} \AgdaBound{1⋙?[2⋙5]} \AgdaBound{3⋙?[4⋙6]}\AgdaSymbol{)} \<[32]%
\>[32]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{=} \AgdaFunction{⟷-branch} \<[13]%
\>[13]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{⋙-assoc} \AgdaBound{1⋙?2} \AgdaBound{[1⋙2]⋙?5} \AgdaBound{2⋙?5} \AgdaBound{1⋙?[2⋙5]}\AgdaSymbol{)} \<[42]%
\>[42]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{⋙-assoc} \AgdaBound{3⋙?4} \AgdaBound{[3⋙4]⋙?6} \AgdaBound{4⋙?6} \AgdaBound{3⋙?[4⋙6]}\AgdaSymbol{)}\<%
\end{code}
}

В качестве более продвинутого варианта для последовательного 
применения рассматривалось следующее определение.

\begin{code}%
\>\AgdaKeyword{module} \AgdaModule{⋙-try1} \AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{data} \AgdaDatatype{\_⋙??\_} \AgdaSymbol{:} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaInductiveConstructor{✶⋙?I} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{p} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{p} \AgdaDatatype{⋙??} \AgdaInductiveConstructor{I}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaInductiveConstructor{Here-⋙?} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{(}\AgdaBound{t₁} \AgdaBound{t₂} \AgdaBound{t₃} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{t₁} \AgdaInductiveConstructor{⇒} \AgdaBound{t₂} \AgdaInductiveConstructor{⟩} \AgdaDatatype{⋙??} \AgdaInductiveConstructor{⟨} \AgdaBound{t₂} \AgdaInductiveConstructor{⇒} \AgdaBound{t₃} \AgdaInductiveConstructor{⟩}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaInductiveConstructor{There-⋙?} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{t₁} \AgdaBound{t₂} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{t} \AgdaSymbol{:} \AgdaDatatype{Tree}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{p₁} \AgdaDatatype{⊏} \AgdaBound{t₁} \AgdaSymbol{→} \AgdaBound{p₂} \AgdaDatatype{⊏} \AgdaBound{t₂} \<[39]%
\>[39]\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{t} \AgdaInductiveConstructor{⇒} \AgdaInductiveConstructor{Branch} \AgdaBound{t₁} \AgdaBound{t₂} \AgdaInductiveConstructor{⟩} \AgdaDatatype{⋙??} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₂} \AgdaInductiveConstructor{⟩}\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaInductiveConstructor{Branch-⋙?} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s₁} \AgdaBound{s₂} \AgdaBound{s₃} \AgdaBound{s₄}\AgdaSymbol{\}} \<[32]%
\>[32]\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{→} \AgdaSymbol{\{}\AgdaBound{p₁} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₂} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₂}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₃} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₃}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p₄} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s₄}\AgdaSymbol{\}}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{L} \AgdaSymbol{:} \AgdaBound{p₁} \AgdaDatatype{⋙??} \AgdaBound{p₂}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaBound{R} \AgdaSymbol{:} \AgdaBound{p₃} \AgdaDatatype{⋙??} \AgdaBound{p₄}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaInductiveConstructor{⟨} \AgdaBound{p₁} \AgdaInductiveConstructor{∧} \AgdaBound{p₃} \AgdaInductiveConstructor{⟩} \AgdaDatatype{⋙??} \AgdaInductiveConstructor{⟨} \AgdaBound{p₂} \AgdaInductiveConstructor{∧} \AgdaBound{p₄} \AgdaInductiveConstructor{⟩}\<%
\end{code}

Отличие от прошлого в том, что появилась опция второму патчу не менять
\emph{сразу} то, что сделал первый, а поменять где-то в глубине
дерева. Однако, в данном варианте оказалось, что доказать некоторые
свойства проблематично и они кажутся не верными. Поэтому, решено
было остановиться на более простом варианте.

\AgdaHide{
\begin{code}%
\>\AgdaComment{--patch-lem : ∀ \{s₁ s₂ : Form\} }\<%
\\
\>\AgdaComment{--  → (x : Tree) → (p : s₁ ∥ s₂)}\<%
\\
\>\AgdaComment{--  → (p₁ : Patch s₁) → (p₂ : Patch s₂)}\<%
\\
\>\AgdaComment{--  → p₁ ⊏ x → p₂ ⊏ x}\<%
\\
\>\AgdaComment{--  → ((p₁ ⋀ p₂) p ⊏ x)}\<%
\\
\>\AgdaComment{--patch-lem x (∅∥✶ .Skip) I I (⊏-I .x) (⊏-I .x) = ⊏-I x}\<%
\\
\>\AgdaComment{--patch-lem x (✶∥∅ .Skip) I I (⊏-I .x) (⊏-I .x) = ⊏-I x}\<%
\\
\>\AgdaComment{--patch-lem x (∅∥✶ .Take) I ⟨ .x ⇒ to ⟩ (⊏-I .x) (⊏-⇒ .x .to) = }\<%
\\
\>\AgdaComment{--  ⊏-⇒ x to}\<%
\\
\>\AgdaComment{--patch-lem x (∅∥✶ .(Branch sl sr)) I (⟨\_∧\_⟩ \{sl\} \{sr\} p₂ p₃) p₁⊏x p₂⊏x = p₂⊏x}\<%
\\
\>\AgdaComment{--patch-lem x (✶∥∅ .Take) ⟨ from ⇒ to ⟩ I p₁⊏x p₂⊏x = p₁⊏x}\<%
\\
\>\AgdaComment{--patch-lem x (✶∥∅ .(Branch sl sr)) (⟨\_∧\_⟩ \{sl\} \{sr\} p₁ p₂) I p₁⊏x p₂⊏x = p₁⊏x}\<%
\\
\>\AgdaComment{--patch-lem (Branch tl tr) (Branch-∥ pl pr) ⟨ p₁ ∧ p₂ ⟩ ⟨ p₃ ∧ p₄ ⟩ (⊏-∧ p₁⊏tl p₂⊏tr) (⊏-∧ p₃⊏tl p₄⊏tr) = }\<%
\\
\>\AgdaComment{--  ⊏-∧ (patch-lem tl pl p₁ p₃ p₁⊏tl p₃⊏tl) }\<%
\\
\>\AgdaComment{--      (patch-lem tr pr p₂ p₄ p₂⊏tr p₄⊏tr)}\<%
\\
\>\AgdaComment{--}\<%
\end{code}

  
--\begin{code}%
\>\<%
\\
\>\AgdaComment{--patch-⊏-indep : \{s : Form\} (p : Patch s) (t : Tree)}\<%
\\
\>\AgdaComment{--  → (⊏₁ ⊏₂ : p ⊏ t)}\<%
\\
\>\AgdaComment{--  → patch p t ⊏₁ ≡ patch p t ⊏₂}\<%
\\
\>\AgdaComment{--patch-⊏-indep I t (⊏-I .t) (⊏-I .t) = refl}\<%
\\
\>\AgdaComment{--patch-⊏-indep ⟨ .t ⇒ to ⟩ t (⊏-⇒ .t .to) (⊏-⇒ .t .to) = refl}\<%
\\
\>\AgdaComment{--patch-⊏-indep (⟨\_∧\_⟩ \{sl\}\{sr\} pl pr) .(Branch tl tr) (⊏-∧ \{.sl\} \{.sr\} \{.pl\} \{.pr\} \{tl\} \{tr\} ⊏₁ ⊏₂) (⊏-∧ ⊏₃ ⊏₄) }\<%
\\
\>\AgdaComment{--  rewrite patch-⊏-indep pl tl ⊏₁ ⊏₃ | patch-⊏-indep pr tr ⊏₂ ⊏₄ = refl}\<%
\end{code}
}
  
\AgdaHide{
\begin{code}%
\>\AgdaComment{-- Неправда}\<%
\\
\>\AgdaComment{--unite-lem : \{s₁ s₂ : Form\} → (∥₁ ∥₂ : s₁ ∥ s₂) → ∥₁ ≡ ∥₂}\<%
\\
\>\AgdaComment{--unite-lem \{.Skip\} \{s₂\} (∅∥✶ .s₂) (∅∥✶ .s₂) = refl}\<%
\\
\>\AgdaComment{--unite-lem (∅∥✶ .Skip) (✶∥∅ .Skip) = \{!!\}}\<%
\\
\>\AgdaComment{--unite-lem (✶∥∅ .Skip) (∅∥✶ .Skip) = \{!!\}}\<%
\\
\>\AgdaComment{--unite-lem \{s₁\} (✶∥∅ .s₁) (✶∥∅ .s₁) = \{!!\}}\<%
\\
\>\AgdaComment{--unite-lem (Branch-∥ ∥₁ ∥₂) (Branch-∥ ∥₃ ∥₄) = \{!!\}}\<%
\\
%
\\
\>\AgdaComment{-- Не тайпчекается}\<%
\\
\>\AgdaComment{--⋀-∥-indep : \{s₁ s₂ : Form\} (p₁ : Patch s₁) (p₂ : Patch s₂)}\<%
\\
\>\AgdaComment{--  → (∥₁ ∥₂ : s₁ ∥ s₂) → }\<%
\\
\>\AgdaComment{--  (p₁ ⋀ p₂) ∥₁ ≡ (p₁ ⋀ p₂) ∥₂}\<%
\\
\>\AgdaComment{--⋀-∥-indep p₁ p₂ ∥₁ ∥₂ = ?}\<%
\end{code}


\begin{code}%
\>\<%
\\
\>\AgdaKeyword{module} \AgdaModule{asfddsfdsf} \AgdaKeyword{where}\<%
\\
%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{I⋀x=x} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{s} \AgdaSymbol{:} \AgdaDatatype{Form}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{p} \AgdaSymbol{:} \AgdaDatatype{Patch} \AgdaBound{s}\AgdaSymbol{)}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{→} \AgdaSymbol{(}\AgdaInductiveConstructor{I} \AgdaFunction{⋀} \AgdaBound{p}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{∅∥✶} \AgdaBound{s}\AgdaSymbol{)} \AgdaDatatype{≡} \AgdaBound{p}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{I⋀x=x} \AgdaInductiveConstructor{I} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{I⋀x=x} \AgdaInductiveConstructor{⟨} \AgdaSymbol{\_} \AgdaInductiveConstructor{⇒} \AgdaSymbol{\_} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{I⋀x=x} \AgdaInductiveConstructor{⟨} \AgdaSymbol{\_} \AgdaInductiveConstructor{∧} \AgdaSymbol{\_} \AgdaInductiveConstructor{⟩} \AgdaSymbol{=} \AgdaInductiveConstructor{refl}\<%
\\
%
\\
\>\AgdaComment{--  ⋀-⋙-lem : ∀ \{fᵃ fᵇ fᶜ' fᶜ'' : Form\}}\<%
\\
\>\AgdaComment{--    (c' : Patch fᶜ')(c'' : Patch fᶜ'')}\<%
\\
\>\AgdaComment{--    (a : Patch fᵃ)(b : Patch fᵇ)}\<%
\\
\>\AgdaComment{--    (c'∥c'' : fᶜ' ∥ fᶜ'') }\<%
\\
\>\AgdaComment{--    (a∥b : fᵃ ∥ fᵇ)}\<%
\\
\>\AgdaComment{--    (a∧b⋙?c : (a ⋀ b) a∥b ⋙? ((c' ⋀ c'') c'∥c''))}\<%
\\
\>\AgdaComment{--    (a⋙?c' : a ⋙? c')}\<%
\\
\>\AgdaComment{--    (b⋙?c'' : b ⋙? c'')}\<%
\\
\>\AgdaComment{--    → ⋙ a∧b⋙?c }\<%
\\
\>\AgdaComment{--      ⟷ ((⋙ a⋙?c') ⋀ (⋙ b⋙?c'')) a∥b}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I I I (∅∥✶ .Skip) (∅∥✶ .Skip) (✶⋙?I .I) (✶⋙?I .I) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl I}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I I I (∅∥✶ .Skip) (✶∥∅ .Skip) (✶⋙?I .I) (✶⋙?I .I) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl I}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I I I (✶∥∅ .Skip) (∅∥✶ .Skip) (✶⋙?I .I) (✶⋙?I .I) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl I}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I I I (✶∥∅ .Skip) (✶∥∅ .Skip) (✶⋙?I .I) (✶⋙?I .I) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl I}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I I ⟨ from ⇒ to ⟩ (∅∥✶ .Skip) (∅∥✶ .Take) (✶⋙?I .(⟨ from ⇒ to ⟩)) (✶⋙?I .I) (✶⋙?I .(⟨ from ⇒ to ⟩)) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ from ⇒ to ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I I ⟨ from ⇒ to ⟩ (✶∥∅ .Skip) (∅∥✶ .Take) (✶⋙?I .(⟨ from ⇒ to ⟩)) (✶⋙?I .I) (✶⋙?I .(⟨ from ⇒ to ⟩)) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ from ⇒ to ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I I ⟨ b ∧ b₁ ⟩ (∅∥✶ .Skip) (∅∥✶ .\_) (✶⋙?I .(⟨ b ∧ b₁ ⟩)) (✶⋙?I .I) (✶⋙?I .(⟨ b ∧ b₁ ⟩)) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ b ∧ b₁ ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I I ⟨ b ∧ b₁ ⟩ (✶∥∅ .Skip) (∅∥✶ .\_) (✶⋙?I .(⟨ b ∧ b₁ ⟩)) (✶⋙?I .I) (✶⋙?I .(⟨ b ∧ b₁ ⟩)) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ b ∧ b₁ ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I ⟨ from ⇒ to ⟩ I (∅∥✶ .Skip) (✶∥∅ .Take) (✶⋙?I .(⟨ from ⇒ to ⟩)) (✶⋙?I .(⟨ from ⇒ to ⟩)) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ from ⇒ to ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I ⟨ from ⇒ to ⟩ I (✶∥∅ .Skip) (✶∥∅ .Take) (✶⋙?I .(⟨ from ⇒ to ⟩)) (✶⋙?I .(⟨ from ⇒ to ⟩)) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ from ⇒ to ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I ⟨ a ∧ a₁ ⟩ I (∅∥✶ .Skip) (✶∥∅ .\_) (✶⋙?I .(⟨ a ∧ a₁ ⟩)) (✶⋙?I .(⟨ a ∧ a₁ ⟩)) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ a ∧ a₁ ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I ⟨ a ∧ a₁ ⟩ I (✶∥∅ .Skip) (✶∥∅ .\_) (✶⋙?I .(⟨ a ∧ a₁ ⟩)) (✶⋙?I .(⟨ a ∧ a₁ ⟩)) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ a ∧ a₁ ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I ⟨ a ∧ a₁ ⟩ ⟨ b ∧ b₁ ⟩ (∅∥✶ .Skip) (Branch-∥ a∥b a∥b₁) (✶⋙?I .(⟨ (a ⋀ b) a∥b ∧ (a₁ ⋀ b₁) a∥b₁ ⟩)) (✶⋙?I .(⟨ a ∧ a₁ ⟩)) (✶⋙?I .(⟨ b ∧ b₁ ⟩)) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ (a ⋀ b) a∥b ∧ (a₁ ⋀ b₁) a∥b₁ ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I I ⟨ a ∧ a₁ ⟩ ⟨ b ∧ b₁ ⟩ (✶∥∅ .Skip) (Branch-∥ a∥b a∥b₁) (✶⋙?I .(⟨ (a ⋀ b) a∥b ∧ (a₁ ⋀ b₁) a∥b₁ ⟩)) (✶⋙?I .(⟨ a ∧ a₁ ⟩)) (✶⋙?I .(⟨ b ∧ b₁ ⟩)) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ (a ⋀ b) a∥b ∧ (a₁ ⋀ b₁) a∥b₁ ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I ⟨ from ⇒ to ⟩ I ⟨ from₁ ⇒ .from ⟩ (∅∥✶ .Take) (∅∥✶ .Take) (Here-⋙? .from₁ .from .to) (✶⋙?I .I) (Here-⋙? .from₁ .from .to) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ from₁ ⇒ to ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I ⟨ c'' ∧ c''' ⟩ I ⟨ b₁ ∧ b ⟩ (∅∥✶ .\_) (∅∥✶ .\_) (Branch-⋙? a∧b⋙?c₁ a∧b⋙?c) (✶⋙?I .I) (Branch-⋙? b⋙?c'' b⋙?c''') }\<%
\\
\>\AgdaComment{--    = ⟷-branch }\<%
\\
\>\AgdaComment{--      (⋙-preserves a∧b⋙?c₁ b⋙?c'') }\<%
\\
\>\AgdaComment{--      (⋙-preserves a∧b⋙?c b⋙?c''')}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem I (⟨\_∧\_⟩ \{sl\}\{sr\} c''₁ c''₂) ⟨ a₁ ∧ a₂ ⟩ ⟨ b₁ ∧ b₂ ⟩ }\<%
\\
\>\AgdaComment{--    (∅∥✶ .(Branch sl sr)) }\<%
\\
\>\AgdaComment{--    (Branch-∥ a₁∥b₁ a₂∥b₂) (Branch-⋙? a∧b⋙?c₁ a∧b⋙?c₂) }\<%
\\
\>\AgdaComment{--    (✶⋙?I .(⟨ a₁ ∧ a₂ ⟩)) (Branch-⋙? b⋙?c''₁ b⋙?c''₂) }\<%
\\
\>\AgdaComment{----    rewrite I⋀x=x c''₁ }\<%
\\
\>\AgdaComment{--    with (I ⋀ c''₁) (∅∥✶ sl) | I⋀x=x c''₁ }\<%
\\
\>\AgdaComment{--  ... | .c''₁ | refl }\<%
\\
\>\AgdaComment{--    = ⟷-branch \{!⋀-⋙-lem I c''₁ a₁ b₁ (∅∥✶ sl) a₁∥b₁ !\} \{!!\}}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem ⟨ from ⇒ to ⟩ I ⟨ from₁ ⇒ .from ⟩ I (✶∥∅ .Take) (✶∥∅ .Take) (Here-⋙? .from₁ .from .to) (Here-⋙? .from₁ .from .to) (✶⋙?I .I) }\<%
\\
\>\AgdaComment{--    = ⟷-refl ⟨ from₁ ⇒ to ⟩}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem ⟨ c' ∧ c'' ⟩ I ⟨ a₁ ∧ a ⟩ I (✶∥∅ .\_) (✶∥∅ .\_) (Branch-⋙? a∧b⋙?c₁ a∧b⋙?c) (Branch-⋙? a⋙?c' a⋙?c'') (✶⋙?I .I) = \{!!\}}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem ⟨ c' ∧ c'' ⟩ I ⟨ a ∧ a₁ ⟩ ⟨ b ∧ b₁ ⟩ (✶∥∅ .\_) (Branch-∥ a∥b a∥b₁) (Branch-⋙? a∧b⋙?c a∧b⋙?c₁) (Branch-⋙? a⋙?c' a⋙?c'') (✶⋙?I .(⟨ b ∧ b₁ ⟩)) = \{!!\}}\<%
\\
\>\AgdaComment{--  ⋀-⋙-lem ⟨ c' ∧ c'' ⟩ ⟨ c''' ∧ c'''' ⟩ ⟨ a ∧ a₁ ⟩ ⟨ b ∧ b₁ ⟩ (Branch-∥ c'∥c'' c'∥c''') (Branch-∥ a∥b a∥b₁) (Branch-⋙? a∧b⋙?c a∧b⋙?c₁) (Branch-⋙? a⋙?c' a⋙?c'') (Branch-⋙? b⋙?c'' b⋙?c''') = \{!!\}}\<%
\end{code}


\begin{code}%
\>\AgdaComment{-- -- Фейл, вестимо}\<%
\\
\>\AgdaComment{-- module ⋙-try1 where}\<%
\\
\>\AgdaComment{--   data \_⋙?\_ : \{s₁ s₂ : Form\} (p₁ : Patch s₁) (p₂ : Patch s₂) → Set where}\<%
\\
\>\AgdaComment{--     ✶⋙?I : ∀ \{s : Form\} (p : Patch s) → p ⋙? I}\<%
\\
\>\AgdaComment{--     Here-⋙? : ∀ (t₁ t₂ t₃ : Tree) → ⟨ t₁ ⇒ t₂ ⟩ ⋙? ⟨ t₂ ⇒ t₃ ⟩}\<%
\\
\>\AgdaComment{--     There-⋙? : ∀ \{s₁ s₂ : Form\} \{t₁ t₂ : Tree\} \{p₁ : Patch s₁\} \{p₂ : Patch s₂\}}\<%
\\
\>\AgdaComment{--       → (t : Tree) → p₁ ⊏ t₁ → p₂ ⊏ t₂ }\<%
\\
\>\AgdaComment{--       → ⟨ t ⇒ Branch t₁ t₂ ⟩ ⋙? ⟨ p₁ ∧ p₂ ⟩}\<%
\\
\>\AgdaComment{--     Branch-⋙? : ∀ \{s₁ s₂ s₃ s₄\} }\<%
\\
\>\AgdaComment{--       → \{p₁ : Patch s₁\} \{p₂ : Patch s₂\} \{p₃ : Patch s₃\} \{p₄ : Patch s₄\}}\<%
\\
\>\AgdaComment{--       → (L : p₁ ⋙? p₂) → (R : p₃ ⋙? p₄) → ⟨ p₁ ∧ p₃ ⟩ ⋙? ⟨ p₂ ∧ p₄ ⟩}\<%
\\
\>\AgdaComment{--   }\<%
\\
\>\AgdaComment{--   ⋙ : \{s₁ s₂ : Form\} \{p₁ : Patch s₁\} \{p₂ : Patch s₂\}}\<%
\\
\>\AgdaComment{--     → p₁ ⋙? p₂ → Patch s₁}\<%
\\
\>\AgdaComment{--   ⋙ (✶⋙?I p₁) = p₁}\<%
\\
\>\AgdaComment{--   ⋙ (Here-⋙? t₁ t₂ t₃) = ⟨ t₁ ⇒ t₃ ⟩}\<%
\\
\>\AgdaComment{--   ⋙ \{p₁ = ⟨ t ⇒ Branch t₁ t₂ ⟩\}\{⟨ p₁ ∧ p₂ ⟩\} (There-⋙? .t p₁⊏t₁ p₂⊏t₂) = }\<%
\\
\>\AgdaComment{--     ⟨ t ⇒ Branch (patch p₁ t₁ p₁⊏t₁) (patch p₂ t₂ p₂⊏t₂)  ⟩}\<%
\\
\>\AgdaComment{--   ⋙ (Branch-⋙? p₁⋙?p₂ p₃⋙?p₄) = ⟨ ⋙ p₁⋙?p₂ ∧ ⋙ p₃⋙?p₄ ⟩}\<%
\\
\>\AgdaComment{--   }\<%
\\
\>\AgdaComment{--   ⋙-assoc : ∀ \{s₁ s₂ s₃ : Form\} \{p₁ : Patch s₁\} \{p₂ : Patch s₂\} \{p₃ : Patch s₃\}}\<%
\\
\>\AgdaComment{--     → (1⋙?2 : p₁ ⋙? p₂)}\<%
\\
\>\AgdaComment{--     → ([1⋙2]⋙?3 : (⋙ 1⋙?2) ⋙? p₃)}\<%
\\
\>\AgdaComment{--     → (2⋙?3 : p₂ ⋙? p₃)}\<%
\\
\>\AgdaComment{--     → (1⋙?[2⋙3] : p₁ ⋙? (⋙ 2⋙?3))}\<%
\\
\>\AgdaComment{--     → (⋙ [1⋙2]⋙?3) ⟷ (⋙ 1⋙?[2⋙3])}\<%
\\
\>\AgdaComment{--   ⋙-assoc (✶⋙?I p₁) (✶⋙?I .p₁) (✶⋙?I .I) (✶⋙?I .p₁) = ⟷-refl p₁}\<%
\\
\>\AgdaComment{--   ⋙-assoc (Here-⋙? t₁ t₂ t₃) (✶⋙?I .(⟨ t₁ ⇒ t₃ ⟩)) (✶⋙?I .(⟨ t₂ ⇒ t₃ ⟩)) (Here-⋙? .t₁ .t₂ .t₃) = ⟷-refl ⟨ t₁ ⇒ t₃ ⟩}\<%
\\
\>\AgdaComment{--   ⋙-assoc (Here-⋙? t₁ t₂ t₃) (Here-⋙? .t₁ .t₃ t₄) (Here-⋙? .t₂ .t₃ .t₄) (Here-⋙? .t₁ .t₂ .t₄) = ⟷-refl ⟨ t₁ ⇒ t₄ ⟩}\<%
\\
\>\AgdaComment{--   ⋙-assoc (Here-⋙? t₁ t₂ .\_) (There-⋙? .t₁ x₁ x) (There-⋙? .t₂ x₂ x₃) (Here-⋙? .t₁ .t₂ .\_) = \{!⟷-refl!\}}\<%
\\
\>\AgdaComment{--   ⋙-assoc (There-⋙? t x x₁) (✶⋙?I .\_) (✶⋙?I .\_) (There-⋙? .t x₂ x₃) = \{!!\}}\<%
\\
\>\AgdaComment{--   ⋙-assoc (There-⋙? t₃ x x₁) (Here-⋙? .t₃ .\_ t₄) () 1⋙?[2⋙3]}\<%
\\
\>\AgdaComment{--   ⋙-assoc (There-⋙? t x x₁) (There-⋙? .t x₃ x₂) (Branch-⋙? 2⋙?3 2⋙?4) (There-⋙? .t x₄ x₅) = \{!!\}}\<%
\\
\>\AgdaComment{--   ⋙-assoc (Branch-⋙? 1⋙?2 1⋙?3) (✶⋙?I .(⟨ ⋙ 1⋙?2 ∧ ⋙ 1⋙?3 ⟩)) (✶⋙?I .\_) (Branch-⋙? 1⋙?[2⋙3] 1⋙?[2⋙3]₁) = \{!!\}}\<%
\\
\>\AgdaComment{--   ⋙-assoc (Branch-⋙? 1⋙?3 1⋙?2) (Branch-⋙? [1⋙2]⋙?4 [1⋙2]⋙?3) (Branch-⋙? 2⋙?3 2⋙?4) (Branch-⋙? 1⋙?[2⋙3] 1⋙?[2⋙3]₁) = \{!!\}}\<%
\\
\>\<%
\end{code}

}

